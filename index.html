<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Markdown parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<style>
body {
  margin: 0;
  display: flex;
  height: 100vh;
  font-family: Arial, sans-serif;
}
#map {
  width: 65%;
  height: 100%;
}
#panel {
  width: 35%;
  padding: 15px;
  overflow-y: auto;
  border-left: 2px solid #ccc;
}
img {
  max-width: 100%;
}
iframe {
  width: 100%;
  height: 250px;
}
</style>
</head>

<body>

<div id="map"></div>
<div id="panel">
  <h2>Welcome</h2>
  <p>Click a marker to load content.</p>
</div>



<script>
const map = L.map('map').setView([20.9618,-39.7297], 8);

// your raster tiles
L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
  minZoom: 8,
  maxZoom: 16,
  noWrap: true
}).addTo(map);

let activeMarker = null;

// load points
fetch('data/points3.geojson')
  .then(res => res.json())
  .then(data => {
    const geoLayer = L.geoJSON(data, {
      pointToLayer: function(feature, latlng) {
        return L.marker(latlng);
      },
      onEachFeature: function(feature, layer) {

        layer.on('click', function() {

          // highlight marker
          if (activeMarker) {
            activeMarker.getElement().classList.remove('active');
          }
          activeMarker = layer;
          layer.getElement().classList.add('active');

          // load markdown
          fetch(feature.properties.content_file)
            .then(r => r.text())
            .then(md => {
			const repoName = window.location.pathname.split('/')[1];

			const html = marked.parse(md);

			// fix image paths
			const fixedHtml = html.replace(/src="images\//g, `src="/${repoName}/images/`);

			document.getElementById('panel').innerHTML = `
			  <h2>${feature.properties.title}</h2>
			  ${fixedHtml}
			`;
            });

        });
      }
    }).addTo(map);

// map.fitBounds(geoLayer.getBounds());
  });
</script>

</body>
</html>